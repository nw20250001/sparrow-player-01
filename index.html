<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SPARROW 音樂播放器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .player-container { background: #1a1a1a; }
        #background-art {
            position: absolute; inset: 0; background-size: cover; background-position: center;
            filter: blur(24px) brightness(0.5); transform: scale(1.1);
            transition: background-image 0.8s ease-in-out; z-index: 0;
        }
        #visualizer-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
        }
        .main-content {
            position: relative; z-index: 2;
            background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.2) 40%, rgba(0,0,0,0.2) 60%, rgba(0,0,0,0.7) 100%);
        }
        #album-art-circle {
            width: 192px; height: 192px; background-size: cover; background-position: center;
            border-radius: 50%; 
            transition: background-image 0.5s ease-in-out, transform 0.1s ease-out;
        }
        .progress-ring__circle {
            transition: stroke-dashoffset 0.3s; transform: rotate(-90deg); transform-origin: 50% 50%;
        }
        .panel {
            transition: transform 0.4s ease-in-out; transform: translateY(100%);
            pointer-events: none;
        }
        .panel.show { transform: translateY(0); pointer-events: auto; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: #f7fafc; cursor: pointer; margin-top: -6px;
        }
        input[type=range][orient=vertical] {
            writing-mode: bt-lr; -webkit-appearance: slider-vertical;
            width: 8px; height: 120px; padding: 0 5px;
        }
        .spinner {
            width: 16px; height: 16px; border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #top-bar { position: absolute; top: 0; left:0; right:0; z-index: 5; }
        .format-tag {
            font-size: 0.6rem; line-height: 1; padding: 3px 6px; border-radius: 4px;
            color: rgba(255,255,255,0.9);
            margin-top: 4px; display: inline-block; font-weight: 500;
        }
        .tab-btn {
            color: #9ca3af;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .tab-btn.active-tab {
            color: #ffffff;
            border-bottom-color: #3b82f6;
        }
        .visualizer-choice-btn.active {
             background-color: #3b82f6;
             color: #ffffff;
        }
    </style>
</head>
<body class="bg-black flex items-center justify-center min-h-screen">
    <div id="player-container" class="w-full max-w-sm h-[80vh] min-h-[600px] max-h-[800px] mx-auto rounded-3xl shadow-2xl overflow-hidden relative player-container">
        <div id="background-art"></div>
        <canvas id="visualizer-canvas"></canvas>
        <div class="main-content h-full w-full flex flex-col">
            <div id="top-bar" class="p-4 flex justify-between items-center text-white">
                 <button data-action="open-visualizer-settings" class="w-10 h-10 text-xl"><i class="fas fa-palette"></i></button>
                 <span id="wakelock-status" class="text-xl opacity-0">☀️</span>
            </div>
            <header class="text-center pt-2 pb-6">
                <p class="text-lg tracking-widest text-gray-200 font-light">SPARROW音樂播放器</p>
            </header>
            <main class="flex-grow flex flex-col items-center justify-center text-center px-6 space-y-6">
                <div id="art-container" class="relative w-56 h-56 flex items-center justify-center">
                    <svg class="absolute inset-0 w-full h-full" viewBox="0 0 120 120">
                        <circle cx="60" cy="60" r="54" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="4"/>
                        <circle id="progress-ring" class="progress-ring__circle" cx="60" cy="60" r="54" fill="none" stroke="white" stroke-width="5" stroke-linecap="round"/>
                    </svg>
                    <div id="album-art-circle" class="rounded-full flex items-center justify-center shadow-lg">
                         <button data-action="toggle-play" class="w-20 h-20 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white transition-opacity duration-300 opacity-70 hover:opacity-100">
                            <i id="play-pause-icon" class="fas fa-play fa-xl ml-1"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <h1 id="track-title" class="text-2xl font-bold text-white truncate max-w-xs">未選擇歌曲</h1>
                    <p id="track-artist" class="text-base text-gray-300">從下方選單新增</p>
                    <div id="format-tag-main" class="h-5 mt-1"></div>
                </div>
            </main>
            <footer class="px-8 pb-10 space-y-6">
                <div class="flex justify-around items-center text-white text-2xl">
                    <button data-action="cycle-playback-mode" id="playback-mode-btn" class="w-10 h-10"></button>
                    <button data-action="prev-track" class="w-10 h-10"><i class="fas fa-backward-step"></i></button>
                    <button data-action="open-eq" class="w-10 h-10"><i class="fas fa-sliders-h text-xl"></i></button>
                    <button data-action="open-playlist" class="w-10 h-10"><i class="fas fa-bars"></i></button>
                    <button data-action="toggle-main-favorite" id="favorite-btn" class="w-10 h-10 text-gray-500"><i class="far fa-heart text-xl"></i></button>
                    <button data-action="next-track" class="w-10 h-10"><i class="fas fa-forward-step"></i></button>
                </div>
                <div class="flex items-center gap-3">
                     <span id="current-time" class="text-xs w-10 text-center text-gray-300">0:00</span>
                     <input type="range" id="progress-bar" value="0" class="w-full h-1 bg-white/20 rounded-full appearance-none cursor-pointer">
                     <span id="duration" class="text-xs w-10 text-center text-gray-300">0:00</span>
                </div>
            </footer>
        </div>
        
        <div id="playlist-container" class="panel absolute inset-0 bg-black/80 backdrop-blur-md flex flex-col z-30">
            <div class="flex justify-between items-center p-4 border-b border-white/10">
                <h2 class="text-lg font-bold text-white">管理清單</h2>
                <button data-action="close-playlist" class="text-2xl text-white">&times;</button>
            </div>
             <div class="flex border-b border-white/10">
                <button data-tab="playlist" class="tab-btn active-tab flex-grow py-3 text-sm font-semibold">播放清單</button>
                <button data-tab="favorites" class="tab-btn flex-grow py-3 text-sm font-semibold">我的最愛</button>
            </div>
            <div class="flex-grow overflow-y-auto relative">
                <ul id="playlist"></ul>
                <ul id="favorites-list" class="hidden"></ul>
            </div>
            <div class="p-4 border-t border-white/10">
                 <div id="playlist-actions" class="flex justify-around items-center pt-2">
                    <label for="file-input" class="cursor-pointer text-center text-gray-300 hover:text-white transition">
                        <i class="fas fa-file-audio fa-lg"></i><span class="block text-xs mt-1">選擇檔案</span>
                    </label>
                    <input type="file" id="file-input" accept="audio/*" multiple class="hidden">
                     <label for="folder-input" class="cursor-pointer text-center text-gray-300 hover:text-white transition">
                        <i class="fas fa-folder-open fa-lg"></i><span class="block text-xs mt-1">選擇資料夾</span>
                    </label>
                    <input type="file" id="folder-input" webkitdirectory directory multiple class="hidden">
                     <button data-action="clear-library" class="text-center text-red-500 hover:text-red-400 transition">
                        <i class="fas fa-trash-alt fa-lg"></i><span class="block text-xs mt-1">清除音樂庫</span>
                    </button>
                </div>
                <div id="favorites-actions" class="flex justify-around items-center pt-2 hidden">
                    <label for="import-favorites-input" class="cursor-pointer text-center text-gray-300 hover:text-white transition">
                        <i class="fas fa-star fa-lg"></i><span class="block text-xs mt-1">匯入最愛</span>
                    </label>
                    <input type="file" id="import-favorites-input" accept=".json" class="hidden">
                    <button data-action="export-favorites" class="text-center text-gray-300 hover:text-white transition">
                        <i class="fas fa-download fa-lg"></i>
                        <span class="block text-xs mt-1">匯出最愛</span>
                    </button>
                </div>
            </div>
        </div>
        <div id="eq-container" class="panel absolute inset-0 bg-black/80 backdrop-blur-md flex flex-col z-30">
             <div class="flex justify-between items-center p-4 border-b border-white/10">
                <h2 class="text-lg font-bold text-white">等化器 (EQ)</h2>
                <button data-action="close-eq" class="text-2xl text-white">&times;</button>
            </div>
            <div class="flex-grow flex flex-col justify-center items-center p-4 space-y-4">
                <div class="flex justify-around w-full text-center text-white">
                    <div class="flex flex-col items-center"><input type="range" orient="vertical" data-action="set-eq" data-index="0" id="eq-slider-0" min="-12" max="12" step="1" value="0"><span class="text-xs mt-2">60Hz</span></div>
                    <div class="flex flex-col items-center"><input type="range" orient="vertical" data-action="set-eq" data-index="1" id="eq-slider-1" min="-12" max="12" step="1" value="0"><span class="text-xs mt-2">400Hz</span></div>
                    <div class="flex flex-col items-center"><input type="range" orient="vertical" data-action="set-eq" data-index="2" id="eq-slider-2" min="-12" max="12" step="1" value="0"><span class="text-xs mt-2">1kHz</span></div>
                    <div class="flex flex-col items-center"><input type="range" orient="vertical" data-action="set-eq" data-index="3" id="eq-slider-3" min="-12" max="12" step="1" value="0"><span class="text-xs mt-2">3kHz</span></div>
                    <div class="flex flex-col items-center"><input type="range" orient="vertical" data-action="set-eq" data-index="4" id="eq-slider-4" min="-12" max="12" step="1" value="0"><span class="text-xs mt-2">10kHz</span></div>
                </div>
                <div class="text-xs text-gray-400">僅支援本地檔案</div>
                <div class="flex flex-wrap justify-center gap-2 pt-4">
                    <button data-action="apply-preset" data-preset="重設" class="bg-white/10 hover:bg-blue-500 text-white text-xs font-semibold py-1 px-3 rounded-full transition">重設</button>
                    <button data-action="apply-preset" data-preset="重低音" class="bg-white/10 hover:bg-blue-500 text-white text-xs font-semibold py-1 px-3 rounded-full transition">重低音</button>
                    <button data-action="apply-preset" data-preset="人聲" class="bg-white/10 hover:bg-blue-500 text-white text-xs font-semibold py-1 px-3 rounded-full transition">人聲</button>
                    <button data-action="apply-preset" data-preset="古典" class="bg-white/10 hover:bg-blue-500 text-white text-xs font-semibold py-1 px-3 rounded-full transition">古典</button>
                </div>
            </div>
        </div>
        <div id="visualizer-settings-container" class="panel absolute inset-0 bg-black/80 backdrop-blur-md flex flex-col z-30 overflow-y-auto">
            <div class="flex justify-between items-center p-4 border-b border-white/10 sticky top-0 bg-black/80 backdrop-blur-md">
                <h2 class="text-lg font-bold text-white">選擇視覺效果</h2>
                <button data-action="close-visualizer-settings" class="text-2xl text-white">&times;</button>
            </div>
            <div class="flex-grow flex flex-col justify-center items-center p-4 space-y-4">
                 <button data-action="set-visualizer" data-style="bars" class="visualizer-choice-btn w-3/4 bg-white/10 hover:bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg transition">環狀光譜</button>
                 <button data-action="set-visualizer" data-style="v_bars" class="visualizer-choice-btn w-3/4 bg-white/10 hover:bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg transition">垂直光譜</button>
                 <button data-action="set-visualizer" data-style="pulse_art" class="visualizer-choice-btn w-3/4 bg-white/10 hover:bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg transition">封面脈動</button>
                 <button data-action="set-visualizer" data-style="side_bars" class="visualizer-choice-btn w-3/4 bg-white/10 hover:bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg transition">兩側光牆</button>
                 <button data-action="set-visualizer" data-style="fountain" class="visualizer-choice-btn w-3/4 bg-white/10 hover:bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg transition">粒子噴泉</button>
                 <button data-action="set-visualizer" data-style="nexus" class="visualizer-choice-btn w-3/4 bg-white/10 hover:bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg transition">星塵連結</button>
            </div>
        </div>
    </div>
    
    <audio id="audio-player" crossOrigin="anonymous"></audio>

    <script>
        // DOM 元素
        const dom = {};
        ['player-container', 'visualizer-canvas', 'art-container', 'background-art', 'album-art-circle', 'track-title', 'track-artist', 'format-tag-main', 'progress-bar', 'current-time', 'duration', 'play-pause-icon', 'favorite-btn', 'playback-mode-btn', 'playlist-container', 'eq-container', 'visualizer-settings-container', 'playlist', 'favorites-list', 'progress-ring', 'audio-player', 'wakelock-status', 'file-input', 'folder-input', 'import-favorites-input', 'playlist-actions', 'favorites-actions'].forEach(id => {
            dom[id.replace(/-/g, '_')] = document.getElementById(id);
        });
        
        const DEFAULT_ART = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIGdyYWRpZW50VHJhbnNmb3JtPSJyb3RhdGUoNDUpIj48c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjMGE1ZjllIi8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjMjk2MmZmIi8+PC9saW5lYXJHcmFkaWVudD48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9InVybCgjZykiLz48L3N2Zz4=';
        const radius = dom.progress_ring.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        dom.progress_ring.style.strokeDasharray = `${circumference} ${circumference}`;
        dom.progress_ring.style.strokeDashoffset = circumference;

        let db; let playlist = []; let currentTrackIndex = -1; let isPlaying = false;
        let audioContext, analyser, sourceNode, dataArrayFreq, animationFrameId, eqNodes = [];
        let wakeLock = null; let favoriteIds = new Set(JSON.parse(localStorage.getItem('favoriteIds')) || []);
        let hueOffset = 0; let activeTab = 'playlist';
        let activeVisualizer = localStorage.getItem('visualizerStyle') || 'bars';
        const playbackModes = ['repeat-all', 'repeat-one', 'shuffle'];
        let currentModeIndex = parseInt(localStorage.getItem('playbackModeIndex')) || 0;
        let playbackMode = playbackModes[currentModeIndex];
        const eqFrequencies = [60, 400, 1000, 3000, 10000];
        const eqPresets = {'重設': [0, 0, 0, 0, 0], '重低音': [7, 5, -2, -1, 0], '人聲': [-2, 0, 5, 4, -1], '古典': [4, 3, -1, 2, 5]};
        const formatColors = { 'MP3': 'bg-blue-800', 'FLAC': 'bg-purple-800', 'WAV': 'bg-green-800', 'M4A': 'bg-orange-800', 'AAC': 'bg-orange-800', 'OGG': 'bg-yellow-800', 'OPUS': 'bg-yellow-800', 'AUDIO': 'bg-gray-600', };
        let particles = []; let nexusParticles = [];

        // --- IndexedDB ---
        function initDB() { return new Promise((resolve, reject) => { const request = indexedDB.open('SparrowMusicDB', 1); request.onupgradeneeded = event => { const db = event.target.result; if (!db.objectStoreNames.contains('tracks')) { db.createObjectStore('tracks', { keyPath: 'persistentId' }); } }; request.onsuccess = event => { db = event.target.result; resolve(db); }; request.onerror = event => reject(event.target.error); }); }
        async function saveTrackToDB(track) { if (!db) return; const transaction = db.transaction(['tracks'], 'readwrite'); const store = transaction.objectStore('tracks'); store.put(track); }
        async function loadTracksFromDB() {
            if (!db) return;
            playlist = [];
            currentTrackIndex = -1;
            const transaction = db.transaction(['tracks'], 'readonly');
            const store = transaction.objectStore('tracks');
            const allTracksReq = store.getAll();
            allTracksReq.onsuccess = () => {
                const tracks = allTracksReq.result.map(track => ({...track, source: URL.createObjectURL(track.file)}));
                playlist.push(...tracks);
                renderLists();
            };
        }
        async function removeTrackFromDB(persistentId) { if (!db) return; const transaction = db.transaction(['tracks'], 'readwrite'); const store = transaction.objectStore('tracks'); store.delete(persistentId); }
        async function clearDB() { if (!db) return; const transaction = db.transaction(['tracks'], 'readwrite'); const store = transaction.objectStore('tracks'); store.clear(); }

        // --- 功能函式 ---
        const saveFavorites = () => localStorage.setItem('favoriteIds', JSON.stringify(Array.from(favoriteIds)));
        function toggleFavorite(index) { if (index < 0 || index >= playlist.length) return; const track = playlist[index]; const trackId = track.persistentId; if (favoriteIds.has(trackId)) { favoriteIds.delete(trackId); } else { favoriteIds.add(trackId); } saveFavorites(); renderLists(); updateMainHeartIcon(); }
        function updateMainHeartIcon() { if (currentTrackIndex > -1) { const isFav = favoriteIds.has(playlist[currentTrackIndex].persistentId); dom.favorite_btn.innerHTML = `<i class="${isFav ? 'fas text-pink-500' : 'far'} fa-heart text-xl"></i>`; } else { dom.favorite_btn.innerHTML = `<i class="far fa-heart text-xl"></i>`; } }
        const updateWakeLockStatus = (isActive) => { dom.wakelock_status.style.opacity = isActive ? '1' : '0'; };
        const acquireWakeLock = async () => { if ('wakeLock' in navigator) { try { if (document.visibilityState !== 'visible' || wakeLock) return; wakeLock = await navigator.wakeLock.request('screen'); updateWakeLockStatus(true); wakeLock.addEventListener('release', () => { wakeLock = null; updateWakeLockStatus(false); }); } catch (err) {} } };
        const releaseWakeLock = async () => { if (wakeLock !== null) { await wakeLock.release(); wakeLock = null; } };
        function setupEQNodes() { eqNodes = eqFrequencies.map((freq, i) => { const filter = audioContext.createBiquadFilter(); filter.type = (i === 0) ? 'lowshelf' : (i === eqFrequencies.length - 1) ? 'highshelf' : 'peaking'; filter.frequency.value = freq; filter.gain.value = 0; return filter; }); sourceNode.connect(eqNodes[0]); for (let i = 0; i < eqNodes.length - 1; i++) { eqNodes[i].connect(eqNodes[i + 1]); } eqNodes[eqNodes.length - 1].connect(analyser); }
        function applyEQPreset(name) { const values = eqPresets[name]; values.forEach((val, i) => { if(eqNodes[i]) eqNodes[i].gain.value = val; document.getElementById(`eq-slider-${i}`).value = val; }); }
        
        // --- 視覺化工具 ---
        function visualizationLoop() {
            animationFrameId = requestAnimationFrame(visualizationLoop);
            if (!analyser) return;
            analyser.getByteFrequencyData(dataArrayFreq);
            const canvasCtx = dom.visualizer_canvas.getContext('2d');
            canvasCtx.clearRect(0, 0, dom.visualizer_canvas.width, dom.visualizer_canvas.height);
            if (activeVisualizer !== 'pulse_art') { dom.album_art_circle.style.transform = 'scale(1)'; }
            switch(activeVisualizer) {
                case 'bars': drawSpectrumBars(canvasCtx); break;
                case 'v_bars': drawVerticalBars(canvasCtx); break;
                case 'pulse_art': handleAlbumArtPulse(); break;
                case 'side_bars': drawSideBars(canvasCtx); break;
                case 'fountain': drawFountain(canvasCtx); break;
                case 'nexus': drawNexus(canvasCtx); break;
            }
        }
        function drawSpectrumBars(ctx) {
            ctx.globalAlpha = 0.8; hueOffset += 0.5;
            const containerRect = dom.player_container.getBoundingClientRect(); const artRect = dom.art_container.getBoundingClientRect();
            const centerX = artRect.left - containerRect.left + artRect.width / 2; const centerY = artRect.top - containerRect.top + artRect.height / 2;
            const radius = dom.art_container.clientWidth / 2 + 10; const bars = 80; const barWidth = 3;
            for (let i = 0; i < bars; i++) {
                const barHeight = dataArrayFreq[i] * 0.4; const angle = (i / bars) * 2 * Math.PI;
                const startX = centerX + Math.cos(angle) * radius; const startY = centerY + Math.sin(angle) * radius;
                const endX = centerX + Math.cos(angle) * (radius + barHeight); const endY = centerY + Math.sin(angle) * (radius + barHeight);
                const hue = (hueOffset + i * 4) % 360; const gradient = ctx.createLinearGradient(startX, startY, endX, endY);
                gradient.addColorStop(0, `hsla(${hue}, 100%, 70%, 0)`); gradient.addColorStop(0.5, `hsla(${hue}, 100%, 60%, 1)`); gradient.addColorStop(1, `hsla(${hue}, 100%, 70%, 0)`);
                ctx.strokeStyle = gradient; ctx.lineWidth = barWidth; ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(endX, endY); ctx.stroke();
            }
        }
        function drawVerticalBars(ctx) {
            ctx.globalAlpha = 0.8; hueOffset += 0.5;
            const bars = 64; const barWidth = dom.visualizer_canvas.width / bars;
            for (let i = 0; i < bars; i++) {
                const barHeight = dataArrayFreq[i] * (dom.visualizer_canvas.height / 255) * 0.6;
                const hue = (hueOffset + i * 5) % 360; ctx.fillStyle = `hsl(${hue}, 100%, 60%)`;
                const x = i * barWidth; const y = dom.visualizer_canvas.height - barHeight; ctx.fillRect(x, y, barWidth, barHeight);
            }
        }
        function handleAlbumArtPulse() { const bass = (dataArrayFreq[0] + dataArrayFreq[1] + dataArrayFreq[2]) / 3; const scale = 1 + (bass / 256) * 0.2; dom.album_art_circle.style.transform = `scale(${scale})`; }
        function drawSideBars(ctx) {
            hueOffset += 0.5; const bars = 64; const barHeight = dom.visualizer_canvas.height / bars;
            for (let i = 0; i < bars; i++) {
                const barLength = dataArrayFreq[i] * (dom.visualizer_canvas.width / 255) * 0.4;
                const hue = (hueOffset + i * 5) % 360;
                const gradientLeft = ctx.createLinearGradient(0, 0, dom.visualizer_canvas.width / 2, 0);
                gradientLeft.addColorStop(0, `hsla(${hue}, 100%, 60%, 0.7)`);
                gradientLeft.addColorStop(1, `hsla(${hue}, 100%, 60%, 0)`);
                ctx.fillStyle = gradientLeft;
                ctx.fillRect(0, i * barHeight, barLength, barHeight);
                
                const gradientRight = ctx.createLinearGradient(dom.visualizer_canvas.width, 0, dom.visualizer_canvas.width / 2, 0);
                gradientRight.addColorStop(0, `hsla(${hue}, 100%, 60%, 0.7)`);
                gradientRight.addColorStop(1, `hsla(${hue}, 100%, 60%, 0)`);
                ctx.fillStyle = gradientRight;
                ctx.fillRect(dom.visualizer_canvas.width - barLength, i * barHeight, barLength, barHeight);
            }
        }
        function drawFountain(ctx) {
            const bass = (dataArrayFreq[2] + dataArrayFreq[3] + dataArrayFreq[4]) / 3;
            if (bass > 180) { for (let i = 0; i < 5; i++) { particles.push({ x: Math.random() * dom.visualizer_canvas.width, y: dom.visualizer_canvas.height, vx: (Math.random() - 0.5) * 4, vy: -Math.random() * 8 - (bass / 255 * 8), alpha: 1, hue: (hueOffset + Math.random() * 60) % 360, size: Math.random() * 3 + 1, }); } }
            ctx.globalAlpha = 1;
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.1; p.alpha -= 0.015;
                if (p.alpha <= 0) { particles.splice(i, 1); continue; }
                ctx.fillStyle = `hsla(${p.hue}, 100%, 70%, ${p.alpha})`; ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
            }
        }
        function drawNexus(ctx) {
            const w = dom.visualizer_canvas.width; const h = dom.visualizer_canvas.height;
            if (nexusParticles.length === 0) { for (let i = 0; i < 100; i++) { nexusParticles.push({ x: Math.random() * w, y: Math.random() * h, vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5, hue: (hueOffset + i * 3.6) % 360, size: Math.random() * 2 + 1.5 }); } }
            const avgVolume = dataArrayFreq.reduce((a, b) => a + b, 0) / dataArrayFreq.length;
            const connectionThreshold = 50 + (avgVolume / 255) * 70;
            for (let i = 0; i < nexusParticles.length; i++) {
                const p1 = nexusParticles[i]; p1.x += p1.vx; p1.y += p1.vy;
                if (p1.x > w) p1.x = 0; if (p1.x < 0) p1.x = w; if (p1.y > h) p1.y = 0; if (p1.y < 0) p1.y = h;
                ctx.fillStyle = `hsl(${p1.hue}, 100%, 70%)`; ctx.beginPath(); ctx.arc(p1.x, p1.y, p1.size, 0, Math.PI * 2); ctx.fill();
                for (let j = i + 1; j < nexusParticles.length; j++) {
                    const p2 = nexusParticles[j]; const dx = p1.x - p2.x; const dy = p1.y - p2.y; const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < connectionThreshold) { const opacity = 1 - (dist / connectionThreshold); ctx.strokeStyle = `hsla(${p1.hue}, 100%, 70%, ${opacity * 0.7})`; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke(); }
                }
            }
        }
       
        // --- 核心播放邏輯 ---
        async function playTrack(index) { if (index < 0 || index >= playlist.length) return; const track = playlist[index]; if (track.type === 'loading') return; if (audioContext && audioContext.state === 'suspended') await audioContext.resume(); acquireWakeLock(); currentTrackIndex = index; dom.track_title.textContent = track.name; dom.track_artist.textContent = track.artist || '未知類型'; updateAlbumArt(track.albumArtUrl); updateMainHeartIcon(); updateFormatTag(); dom.visualizer_canvas.style.display = 'block'; document.querySelector('[data-action="open-eq"]').disabled = false; document.querySelector('[data-action="open-eq"]').classList.remove('opacity-50'); if(animationFrameId) cancelAnimationFrame(animationFrameId); visualizationLoop(); dom.audio_player.src = track.source; try { await dom.audio_player.play(); } catch (err) {} }
        async function stopPlayback() { dom.audio_player.pause(); isPlaying = false; currentTrackIndex = -1; releaseWakeLock(); if(animationFrameId) cancelAnimationFrame(animationFrameId); const canvasCtx = dom.visualizer_canvas.getContext('2d'); canvasCtx.clearRect(0, 0, dom.visualizer_canvas.width, dom.visualizer_canvas.height); dom.visualizer_canvas.style.display = 'none'; updatePlayPauseIcon(); updateAlbumArt(null); updateMainHeartIcon(); updateFormatTag(); dom.track_title.textContent = "未選擇歌曲"; dom.track_artist.textContent = "從下方選單新增"; resetProgress(); renderLists(); }

        // --- UI 更新函式 ---
        function getFormatTagHTML(track) { let format = '...'; const filename = track.originalFilename; if (track.type === 'loading') { format = '讀取中'; return `<span class="format-tag bg-gray-600">${format}</span>`; } else if (filename) { const ext = filename.split('.').pop().toUpperCase(); format = ['MP3', 'WAV', 'FLAC', 'M4A', 'AAC', 'OGG', 'OPUS'].includes(ext) ? ext : 'AUDIO'; } const colorClass = formatColors[format] || 'bg-gray-600'; return `<span class="format-tag ${colorClass}">${format}</span>`; }
        function createTrackListItemHTML(track, index) { const isFav = favoriteIds.has(track.persistentId); const formatTagHTML = getFormatTagHTML(track); return `<li class="p-3 flex items-center justify-between cursor-pointer hover:bg-white/10 ${index === currentTrackIndex ? 'bg-white/10 text-blue-400' : ''}"><div data-action="play-track" data-index="${index}" class="flex items-center gap-3 truncate flex-grow"><img src="${track.albumArtUrl || DEFAULT_ART}" class="w-12 h-12 rounded-md bg-white/10 object-cover"><div class="truncate"><span class="truncate block text-white">${track.name || '讀取中...'}</span><div class="flex items-center">${formatTagHTML}</div></div></div><div class="flex items-center ml-2"><button data-action="toggle-favorite" data-index="${index}" class="p-2 text-xl ${isFav ? 'text-pink-500' : 'text-gray-500'} hover:text-pink-400"><i class="${isFav ? 'fas' : 'far'} fa-heart"></i></button><button data-action="remove-track" data-index="${index}" class="p-2 text-xl text-gray-500 hover:text-white transition-colors"><i class="fas fa-trash"></i></button></div></li>`; }
        function renderLists() {
            dom.playlist.innerHTML = playlist.length > 0 ? playlist.map(createTrackListItemHTML).join('') : `<li class="p-4 text-center text-gray-500 text-sm">播放清單是空的</li>`;
            const favoritedTracks = playlist.filter(track => favoriteIds.has(track.persistentId));
            dom.favorites_list.innerHTML = favoritedTracks.length > 0 ? favoritedTracks.map((track) => { const originalIndex = playlist.findIndex(p => p.persistentId === track.persistentId); return createTrackListItemHTML(track, originalIndex); }).join('') : `<li class="p-4 text-center text-gray-500 text-sm">沒有最愛的歌曲</li>`;
        }
        function updateFormatTag() { if (currentTrackIndex > -1) { const track = playlist[currentTrackIndex]; dom.format_tag_main.innerHTML = getFormatTagHTML(track); } else { dom.format_tag_main.innerHTML = ''; } }
        function switchTab(tab) { activeTab = tab; document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active-tab', btn.dataset.tab === tab)); dom.playlist.classList.toggle('hidden', tab !== 'playlist'); dom.favorites_list.classList.toggle('hidden', tab !== 'favorites'); dom.playlist_actions.classList.toggle('hidden', tab !== 'playlist'); dom.favorites_actions.classList.toggle('hidden', tab !== 'favorites'); }
        function updateVisualizerChoiceUI() { document.querySelectorAll('.visualizer-choice-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.style === activeVisualizer)); }
        function cyclePlaybackMode() { currentModeIndex = (currentModeIndex + 1) % playbackModes.length; playbackMode = playbackModes[currentModeIndex]; localStorage.setItem('playbackModeIndex', currentModeIndex); updatePlaybackModeIcon(); }
        function updatePlaybackModeIcon() {
            const btn = dom.playback_mode_btn;
            switch(playbackMode) {
                case 'repeat-all': btn.innerHTML = `<i class="fas fa-repeat text-xl"></i>`; btn.title = "全部循環"; break;
                case 'repeat-one': btn.innerHTML = `<span class="inline-block align-middle text-xl leading-none"><span class="fa-stack"><i class="fas fa-repeat fa-stack-2x"></i><strong class="fa-stack-1x fa-inverse" style="font-family: sans-serif; font-size: 0.6em; margin-top: -0.05em;">1</strong></span></span>`; btn.title = "單曲循環"; break;
                case 'shuffle': btn.innerHTML = `<i class="fas fa-shuffle text-xl"></i>`; btn.title = "隨機播放"; break;
            }
        }

        // --- 事件委派 & 控制 ---
        dom.player_container.addEventListener('click', async (e) => {
            const target = e.target.closest('[data-action], [data-tab]'); if (!target) return;
            const { action, index, preset, tab, style } = target.dataset; if (tab) { switchTab(tab); return; }
            switch (action) {
                case 'toggle-play': await togglePlayPause(); break;
                case 'next-track': playNext(); break;
                case 'prev-track': playPrev(); break;
                case 'toggle-main-favorite': toggleFavorite(currentTrackIndex); break;
                case 'cycle-playback-mode': cyclePlaybackMode(); break;
                case 'open-playlist': dom.playlist_container.classList.add('show'); renderLists(); break;
                case 'close-playlist': dom.playlist_container.classList.remove('show'); break;
                case 'open-eq': dom.eq_container.classList.add('show'); break;
                case 'close-eq': dom.eq_container.classList.remove('show'); break;
                case 'open-visualizer-settings': dom.visualizer_settings_container.classList.add('show'); updateVisualizerChoiceUI(); break;
                case 'close-visualizer-settings': dom.visualizer_settings_container.classList.remove('show'); break;
                case 'set-visualizer': activeVisualizer = style; localStorage.setItem('visualizerStyle', style); updateVisualizerChoiceUI(); if (activeVisualizer !== 'fountain') particles = []; if (activeVisualizer !== 'nexus') nexusParticles = []; dom.visualizer_settings_container.classList.remove('show'); break;
                case 'export-favorites': exportFavorites(); break;
                case 'play-track': playTrack(parseInt(index)); dom.playlist_container.classList.remove('show'); break;
                case 'toggle-favorite': toggleFavorite(parseInt(index)); break;
                case 'apply-preset': applyEQPreset(preset); break;
                case 'remove-track': removeTrack(parseInt(index)); break;
                case 'clear-library': if(confirm('確定要清除所有儲存在瀏覽器中的歌曲嗎？此操作無法復原。')) { await clearDB(); stopPlayback(); playlist = []; renderLists(); } break;
            }
        });
        dom.player_container.addEventListener('input', (e) => { const target = e.target.closest('[data-action]'); if (!target) return; if (target.dataset.action === 'set-eq') { const { index } = target.dataset; if (eqNodes[index]) eqNodes[index].gain.value = e.target.value; } });
        
        function exportFavorites() { const favoritedTracks = playlist.filter(track => favoriteIds.has(track.persistentId)); if (favoritedTracks.length === 0) { showTemporaryMessage('沒有最愛歌曲可匯出'); return; } const exportData = favoritedTracks.map(({ id, source, file, ...rest }) => rest); const dataStr = JSON.stringify(exportData, null, 2); const dataBlob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(dataBlob); const a = document.createElement('a'); a.href = url; a.download = 'sparrow-favorites.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }
        function updatePlaylistEntry(id, newTrackData) { const index = playlist.findIndex(track => track.id === id); if (index !== -1) { playlist[index] = { ...playlist[index], ...newTrackData, type: 'local' }; saveTrackToDB(playlist[index]); renderLists(); if (playlist.length === 1 && currentTrackIndex === -1) { playTrack(0); } } }
        function setupAudioContext() { if (!audioContext) { try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); sourceNode = audioContext.createMediaElementSource(dom.audio_player); analyser = audioContext.createAnalyser(); analyser.fftSize = 256; setupEQNodes(); analyser.connect(audioContext.destination); dataArrayFreq = new Uint8Array(analyser.frequencyBinCount); } catch (e) {} } }
        function setupCanvas() { const c = dom.player_container; dom.visualizer_canvas.width = c.clientWidth; dom.visualizer_canvas.height = c.clientHeight; }
        function showTemporaryMessage(message, isError = false) { const originalText = dom.track_artist.textContent; dom.track_artist.textContent = message; dom.track_artist.classList.toggle('text-red-400', isError); setTimeout(() => { const track = playlist[currentTrackIndex]; dom.track_artist.textContent = track ? (track.artist || '未知藝人') : '從下方選單新增'; dom.track_artist.classList.remove('text-red-400'); }, 3000); }
        function setProgressRing(percent) { const offset = circumference - (percent / 100) * circumference; dom.progress_ring.style.strokeDashoffset = offset; }
        function removeTrack(index) { if (index < 0 || index >= playlist.length) return; const track = playlist[index]; favoriteIds.delete(track.persistentId); saveFavorites(); removeTrackFromDB(track.persistentId); URL.revokeObjectURL(track.source); playlist.splice(index, 1); if (index === currentTrackIndex) { if (playlist.length > 0) { const nextIndex = index >= playlist.length ? 0 : index; playTrack(nextIndex); } else { stopPlayback(); } } else if (index < currentTrackIndex) { currentTrackIndex--; } renderLists(); }
        async function togglePlayPause() { if (currentTrackIndex === -1 && playlist.length > 0) { playTrack(0); return; } if (currentTrackIndex === -1) return; if (audioContext && audioContext.state === 'suspended') await audioContext.resume(); isPlaying = !isPlaying; if (isPlaying) { await dom.audio_player.play(); acquireWakeLock(); } else { dom.audio_player.pause(); releaseWakeLock(); } updatePlayPauseIcon(); }
        
        function playRandom() { if (playlist.length <= 1) { playTrack(0); return; } let nextIndex; do { nextIndex = Math.floor(Math.random() * playlist.length); } while (nextIndex === currentTrackIndex); playTrack(nextIndex); }
        function playNext() { if (playbackMode === 'shuffle') { playRandom(); } else { let i = currentTrackIndex + 1; if (i >= playlist.length) i = 0; playlist.length > 0 ? playTrack(i) : stopPlayback(); } }
        function playPrev() { if (playbackMode === 'shuffle') { playRandom(); } else { let i = currentTrackIndex - 1; if (i < 0) i = playlist.length - 1; playlist.length > 0 ? playTrack(i) : stopPlayback(); } }
        function handleSongEnd() { if (playbackMode === 'repeat-one') { playTrack(currentTrackIndex); } else { playNext(); } }

        function updatePlayPauseIcon() { dom.play_pause_icon.className = isPlaying ? 'fas fa-pause fa-xl' : 'fas fa-play fa-xl ml-1'; }
        function updateAlbumArt(artUrl) { const finalArtUrl = artUrl || DEFAULT_ART; dom.background_art.style.backgroundImage = `url('${finalArtUrl}')`; dom.album_art_circle.style.backgroundImage = `url('${finalArtUrl}')`; if (!artUrl) { dom.album_art_circle.classList.add('bg-white/10', 'backdrop-blur-sm'); } else { dom.album_art_circle.classList.remove('bg-white/10', 'backdrop-blur-sm'); } }
        function updateProgress() { if (currentTrackIndex === -1) return; const currentTime = dom.audio_player.currentTime; const duration = dom.audio_player.duration; if (duration && !isNaN(duration)) { let p = (currentTime / duration) * 100; dom.progress_bar.value = p; setProgressRing(p); dom.current_time.textContent = formatTime(currentTime); dom.duration.textContent = formatTime(duration); } }
        function resetProgress() { dom.progress_bar.value = 0; setProgressRing(0); dom.current_time.textContent = '0:00'; dom.duration.textContent = '0:00'; }
        dom.progress_bar.addEventListener('input', () => { if (currentTrackIndex === -1) return; const duration = dom.audio_player.duration; if (duration) { dom.audio_player.currentTime = (dom.progress_bar.value / 100) * duration; } });
        function formatTime(s) { if (isNaN(s) || s < 0) return "0:00"; const min = Math.floor(s / 60); const sec = Math.floor(s % 60); return `${min}:${sec < 10 ? '0' : ''}${sec}`; }
        
        function processFiles(files) {
            Array.from(files).filter(file => file.type.startsWith('audio/') || file.name.endsWith('.mqa')).forEach(file => {
                const persistentId = `${file.name}-${file.size}-${file.lastModified}`;
                if (playlist.some(track => track.persistentId === persistentId)) { return; }
                const placeholderId = `placeholder-${Date.now()}-${Math.random()}`;
                const trackData = { id: placeholderId, type: 'loading', name: file.name, originalFilename: file.name, persistentId: persistentId, file: file };
                playlist.push({...trackData, source: URL.createObjectURL(file)});
                saveTrackToDB(trackData);
                renderLists();
                setTimeout(() => {
                    window.jsmediatags.read(file, {
                        onSuccess: (tag) => {
                            const art = tag.tags.picture; let artUrl = null;
                            if (art) { let base64 = ""; for (let i = 0; i < art.data.length; i++) { base64 += String.fromCharCode(art.data[i]); } artUrl = `data:${art.format};base64,${window.btoa(base64)}`; }
                            updatePlaylistEntry(placeholderId, { name: tag.tags.title || file.name, artist: tag.tags.artist || '未知藝人', albumArtUrl: artUrl });
                        },
                        onError: (error) => {
                            updatePlaylistEntry(placeholderId, { name: file.name, artist: '未知藝人', albumArtUrl: null });
                        }
                    });
                }, 0);
            });
        }

        // --- Event Listeners ---
        dom.audio_player.addEventListener('play', () => { isPlaying = true; updatePlayPauseIcon(); acquireWakeLock(); });
        dom.audio_player.addEventListener('pause', () => { isPlaying = false; updatePlayPauseIcon(); releaseWakeLock(); });
        dom.audio_player.addEventListener('timeupdate', updateProgress);
        dom.audio_player.addEventListener('ended', handleSongEnd);
        dom.audio_player.addEventListener('loadedmetadata', updateProgress);
        window.addEventListener('resize', setupCanvas);
        document.body.addEventListener('click', setupAudioContext, { once: true });
        dom.file_input.addEventListener('change', (e) => { processFiles(e.target.files); e.target.value = ''; });
        dom.folder_input.addEventListener('change', (e) => { processFiles(e.target.files); e.target.value = ''; });
        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible' && isPlaying) { acquireWakeLock(); } });
        dom.import_favorites_input.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { try { const importedFavorites = JSON.parse(event.target.result); if (!Array.isArray(importedFavorites)) { throw new Error('Invalid format'); } importedFavorites.forEach(fav => { if (fav.persistentId) { favoriteIds.add(fav.persistentId); } }); saveFavorites(); renderLists(); updateMainHeartIcon(); showTemporaryMessage(`成功同步最愛清單`); } catch (error) { showTemporaryMessage('匯入失敗，檔案格式錯誤', true); } finally { e.target.value = ''; } }; reader.readAsText(file); });

        // --- Initialization ---
        async function initializeApp() {
            setupCanvas();
            updateAlbumArt(null);
            updateMainHeartIcon();
            updatePlaybackModeIcon();
            dom.visualizer_canvas.style.display = 'none';
            await initDB();
            await loadTracksFromDB();
        }

        initializeApp();

    </script>
</body>
</html>
